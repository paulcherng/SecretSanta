<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>抽籤後台</title>
    <style>
        body { font-family: sans-serif; max-width: 1000px; margin: 40px auto; padding: 0 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; word-break: break-all; }
        th { background-color: #f2f2f2; }
        button { cursor: pointer; padding: 5px 10px; margin: 0 5px; }
        .controls button { padding: 8px 15px; margin: 10px 5px 10px 0; }
        .delete-btn { background-color: #f8d7da; border-color: #f5c6cb; }
        .danger-zone { border: 2px solid #c12a2a; padding: 15px; margin-top: 30px; border-radius: 5px; }
        .danger-zone button { background-color: #c12a2a; color: white; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .message { padding: 10px; margin-top: 15px; border-radius: 5px; }
        .message.success { background-color: #d4edda; color: #155724; }
        .message.error { background-color: #f8d7da; color: #721c24; }
        /* 需求 2: 隱藏願望的樣式 */
        .wish-content.hidden { color: transparent; text-shadow: 0 0 8px rgba(0,0,0,0.5); user-select: none; cursor: pointer; }
    </style>
</head>
<body>
    <h1>後台管理</h1>
    <div id="login-section">
        <label for="secret">請輸入管理密碼:</label>
        <input type="password" id="secret">
        <button onclick="login()">登入</button>
    </div>

    <div id="admin-panel" style="display:none;">
        <div id="message-area"></div>
        <h2>目前參與者列表</h2>
        <p id="status-text"></p>
        <div id="participants-table"></div>
        <div class="controls">
            <button onclick="toggleWishes(this)">顯示願望</button>
            <button id="draw-button" onclick="startDraw()">執行抽籤</button>
            <button id="send-button" onclick="sendEmails()">寄送通知信</button>
            <button onclick="loadStatus()">重新整理</button>
        </div>
        <div class="danger-zone">
            <h3>危險操作區</h3>
            <button onclick="resetSystem()">重置整個系統</button>
        </div>
    </div>

    <script>
        const loginSection = document.getElementById('login-section');
        const adminPanel = document.getElementById('admin-panel');
        const messageArea = document.getElementById('message-area');
        const statusText = document.getElementById('status-text');
        const participantsTable = document.getElementById('participants-table');
        const drawButton = document.getElementById('draw-button');
        const sendButton = document.getElementById('send-button');
        let adminSecret = '';

        function showMessage(text, type = 'error') {
            messageArea.innerHTML = `<div class="message ${type}">${text}</div>`;
        }

        function login() {
            adminSecret = document.getElementById('secret').value;
            if (!adminSecret) { alert('請輸入密碼'); return; }
            loadStatus();
        }

        async function apiFetch(url, options = {}) {
            const headers = { 'Content-Type': 'application/json', ...options.headers, 'Authorization': `Bearer ${adminSecret}` };
            const response = await fetch(url, { ...options, headers });
            if (response.status === 401) { throw new Error('密碼錯誤或憑證已過期。'); }
            return response;
        }

        async function loadStatus() {
            const groupMap = { 1: '光佑', 2: 'Jefferson', 3: 'PJ一家', 4: '瑞君一家', 5: '豪哥一家' };
            try {
                const response = await apiFetch('/api/status');
                if (!response.ok) throw new Error('無法載入資料');
                
                const data = await response.json();
                loginSection.style.display = 'none';
                adminPanel.style.display = 'block';
                messageArea.innerHTML = '';

                statusText.textContent = `人數: ${data.count} / 8`;
                
                let html = '<table><tr><th>ID</th><th>名字</th><th>組別</th><th onclick="toggleWishes(document.querySelector(\'.controls button\'))" style="cursor:pointer;">許願內容 👁️</th><th>抽到誰(ID)</th><th>操作</th></tr>';
                const participants = data.participants || [];

                participants.forEach(p => {
                    html += `<tr>
                        <td>${p.id}</td>
                        <td>${p.name}</td>
                        <td>${groupMap[p.group_id] || '未知'}</td>
                        <td class="wish-content hidden">${p.wish}</td>
                        <td>${p.assigned_to || 'N/A'}</td>
                        <td><button class="delete-btn" onclick="deleteParticipant(${p.id}, '${p.name}')" ${data.draw_completed ? 'disabled' : ''}>刪除</button></td>
                    </tr>`;
                });
                html += '</table>';
                participantsTable.innerHTML = html;

                // 更新按鈕狀態
                const canDraw = data.count === 8 && !data.draw_completed;
                const canSend = data.draw_completed && !data.emails_sent;
                drawButton.disabled = !canDraw;
                sendButton.disabled = !canSend;
                
                if (data.draw_completed) drawButton.textContent = '已抽籤';
                else drawButton.textContent = '執行抽籤';
                if (data.emails_sent) sendButton.textContent = '已寄信';
                else sendButton.textContent = '寄送通知信';

            } catch (error) { alert(error.message); adminSecret = ''; }
        }

        // 需求 2: 顯示/隱藏願望
        function toggleWishes(button) {
            const wishes = document.querySelectorAll('.wish-content');
            const isHidden = wishes[0]?.classList.contains('hidden');
            wishes.forEach(w => w.classList.toggle('hidden'));
            button.textContent = isHidden ? '隱藏願望' : '顯示願望';
        }

        async function startDraw() {
            if (!confirm('確定要執行抽籤嗎？此動作將儲存配對結果。')) return;
            drawButton.disabled = true;
            try {
                const response = await apiFetch('/api/draw', { method: 'POST' });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);
                showMessage(result.message, 'success');
                loadStatus();
            } catch (error) { showMessage(error.message, 'error'); loadStatus(); }
        }
        
        // 需求 4: 帶有金額提示的寄信功能
        async function sendEmails() {
            const giftAmount = prompt("請輸入禮物金額範圍 (例如：$500-$700元)", "$500 - $700 元");
            if (!giftAmount) return; // 如果使用者取消輸入

            sendButton.disabled = true;
            showMessage('正在準備寄送所有信件，請稍候...', 'info');
            try {
                const response = await apiFetch('/api/send-emails', {
                    method: 'POST',
                    body: JSON.stringify({ giftAmount: giftAmount })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);
                showMessage(result.message, 'success');
                loadStatus();
            } catch (error) { showMessage(error.message, 'error'); loadStatus(); }
        }

        // 其他函式 (deleteParticipant, resetSystem) 保持不變
        async function deleteParticipant(userId, userName) {
            if (!confirm(`您確定要刪除「${userName}」的資料嗎？`)) return;
            try {
                const response = await apiFetch('/api/delete-user', { method: 'POST', body: JSON.stringify({ userId }) });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);
                showMessage(result.message, 'success'); loadStatus();
            } catch (error) { showMessage(error.message, 'error'); }
        }
        async function resetSystem() {
            if (!confirm('！！！警告！！！\n您確定要清空所有資料嗎？此操作無法復原！')) return;
            try {
                const response = await apiFetch('/api/reset', { method: 'POST' });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);
                showMessage(result.message, 'success'); loadStatus();
            } catch (error) { showMessage(error.message, 'error'); }
        }
    </script>
</body>
</html>```

---

### 如何實施

1.  **修改檔案**：
    *   用新版程式碼**覆蓋** `api/submit.js`。
    *   用新版程式碼**覆蓋** `api/draw.js`。
    *   用新版程式碼**覆蓋** `admin.html`。
2.  **建立新檔案**：
    *   在 `api` 資料夾中，**建立** `api/send-emails.js` 並貼上對應的程式碼。
3.  **重新部署**：
    *   將所有修改（2個修改過的檔案 + 1個新檔案）上傳到 GitHub，讓 Vercel 進行部署。

部署完成後，您的抽籤系統就擁有了全部新功能！
