<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>抽籤後台</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 40px auto; padding: 0 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .message { padding: 10px; margin-top: 15px; border-radius: 5px; }
        .message.success { background-color: #d4edda; color: #155724; }
        .message.error { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>後台管理</h1>
    <div id="login-section">
        <label for="secret">請輸入管理密碼:</label>
        <input type="password" id="secret">
        <button onclick="login()">登入</button>
    </div>

    <div id="admin-panel" style="display:none;">
        <div id="message-area"></div>
        <h2>目前參與者列表</h2>
        <p id="status-text"></p>
        <div id="participants-table"></div>
        <br>
        <button id="draw-button" onclick="startDraw()">執行抽籤</button>
        <button onclick="loadStatus()">重新整理</button>
    </div>

    <script>
        const loginSection = document.getElementById('login-section');
        const adminPanel = document.getElementById('admin-panel');
        const messageArea = document.getElementById('message-area');
        const statusText = document.getElementById('status-text');
        const participantsTable = document.getElementById('participants-table');
        const drawButton = document.getElementById('draw-button');
        let adminSecret = '';

        function showMessage(text, type = 'error') {
            messageArea.innerHTML = `<div class="message ${type}">${text}</div>`;
        }

        function login() {
            adminSecret = document.getElementById('secret').value;
            if (!adminSecret) {
                alert('請輸入密碼');
                return;
            }
            loadStatus();
        }

        async function apiFetch(url, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers,
                'Authorization': `Bearer ${adminSecret}` // 將密碼放在 Header
            };
            const response = await fetch(url, { ...options, headers });
            if (response.status === 401) {
                throw new Error('密碼錯誤或憑證已過期。');
            }
            return response;
        }

        // 在 admin.html 的 <script> 標籤中，找到 loadStatus 函式並整個替換掉

        async function loadStatus() {
            // 建立一個 組別ID -> 組別名稱 的對照表
            const groupMap = {
                1: '光佑',
                2: 'Jefferson',
                3: 'PJ一家',
                4: '瑞君一家',
                5: '豪哥一家'
            };
        
            try {
                const response = await apiFetch('/api/status');
                if (!response.ok) throw new Error('無法載入資料');
                
                const data = await response.json();
                loginSection.style.display = 'none';
                adminPanel.style.display = 'block';
                messageArea.innerHTML = '';
        
                statusText.textContent = `人數: ${data.count} / 8`;
                
                // 建立新的表格標頭
                let html = '<table><tr><th>ID</th><th>名字</th><th>Email</th><th>組別</th><th>許願內容</th><th>抽到誰(ID)</th><th>對方的願望</th></tr>';
                
                const participants = data.participants;
        
                participants.forEach(p => {
                    // 查找抽到的對象
                    const target = p.assigned_to ? participants.find(targetPerson => targetPerson.id === p.assigned_to) : null;
                    
                    html += `<tr>
                        <td>${p.id}</td>
                        <td>${p.name}</td>
                        <td>${p.email}</td>
                        <td>${groupMap[p.group_id] || '未知'}</td>
                        <td style="max-width: 200px; word-wrap: break-word;">${p.wish}</td>
                        <td>${p.assigned_to || 'N/A'}</td>
                        <td style="max-width: 200px; word-wrap: break-word;">${target ? target.wish : 'N/A'}</td>
                    </tr>`;
                });
                html += '</table>';
                participantsTable.innerHTML = html;
        
                if (data.draw_completed) {
                    drawButton.disabled = true;
                    drawButton.textContent = '抽籤已完成';
                    showMessage('抽籤已完成。結果如上表所示。', 'success');
                } else if (data.count < 8) {
                    drawButton.disabled = true;
                    drawButton.textContent = '人數未滿';
                } else {
                    drawButton.disabled = false;
                    drawButton.textContent = '執行抽籤';
                }
            } catch (error) {
                alert(error.message);
                adminSecret = '';
            }
        }

        async function startDraw() {
            if (!confirm('確定要執行抽籤嗎？此動作無法復原！')) return;
            
            drawButton.disabled = true;
            drawButton.textContent = '抽籤與寄信中...';
            showMessage('正在執行中，請勿關閉視窗...', 'info');

            try {
                const response = await apiFetch('/api/draw', { method: 'POST' });
                const result = await response.json();

                if (!response.ok) throw new Error(result.message);

                showMessage(result.message, 'success');
                loadStatus(); // 重新載入以顯示結果
            } catch (error) {
                showMessage(error.message, 'error');
                drawButton.disabled = false;
                drawButton.textContent = '執行抽籤';
            }
        }
    </script>
</body>
</html>
