<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æŠ½ç±¤å¾Œå°</title>
    <style>
    /* --- å…¨åŸŸèˆ‡åŸºæœ¬ä½ˆå±€ --- */
    :root {
        --primary-color: #007bff;
        --success-color: #28a745;
        --danger-color: #dc3545;
        --light-gray: #f8f9fa;
        --border-color: #dee2e6;
        --text-color: #212529;
        --text-muted: #6c757d;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background-color: var(--light-gray);
        color: var(--text-color);
        margin: 0;
        padding: 40px 20px;
    }

    h1, h2, h3 {
        color: var(--text-color);
    }
    h1 { text-align: center; margin-bottom: 2rem; }

    #login-section,
    #admin-panel {
        max-width: 1000px;
        margin: 0 auto;
        background-color: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    /* --- è¡¨æ ¼æ¨£å¼ --- */
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1.5rem;
    }

    th, td {
        border-bottom: 1px solid var(--border-color);
        padding: 12px 15px;
        text-align: left;
        vertical-align: middle;
        word-break: break-all;
    }
    
    th {
        background-color: var(--light-gray);
        font-weight: 600;
        color: var(--text-muted);
    }
    tr:last-child td {
        border-bottom: none;
    }
    tr:hover {
        background-color: #f1f3f5;
    }

    /* --- æŒ‰éˆ•æ¨£å¼ --- */
    button {
        border: 1px solid transparent;
        border-radius: 6px;
        padding: 8px 16px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        margin: 0 4px;
    }

    button:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
    }

    /* é è¨­æŒ‰éˆ• (æ¬¡è¦æ“ä½œ) */
    .controls button, .danger-zone button {
        background-color: #6c757d;
        color: white;
        border-color: #6c757d;
    }
    .controls button:hover, .danger-zone button:hover {
        background-color: #5a6268;
    }

    /* ä¸»è¦æ“ä½œæŒ‰éˆ• */
    #draw-button, #send-button {
        background-color: var(--primary-color);
        color: white;
    }
    #draw-button:hover, #send-button:hover {
        background-color: #0069d9;
    }
    
    /* åˆªé™¤æŒ‰éˆ• */
    .delete-btn {
        background-color: transparent;
        color: var(--danger-color);
        border-color: var(--danger-color);
    }
    .delete-btn:hover {
        background-color: var(--danger-color);
        color: white;
    }

    /* ç¦ç”¨ç‹€æ…‹ */
    button:disabled {
        background-color: #e9ecef;
        border-color: #e9ecef;
        color: #6c757d;
        cursor: not-allowed;
        opacity: 0.65;
    }

    /* --- æ§åˆ¶å€èˆ‡å±éšªå€ --- */
    .controls {
        margin-top: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--border-color);
    }

    .danger-zone {
        border: 1px solid #f5c6cb;
        background-color: #f8d7da;
        color: #721c24;
        padding: 1rem 1.5rem;
        margin-top: 1.5rem;
        border-radius: 8px;
    }
    .danger-zone h3 { margin-top: 0; color: #721c24; }
    .danger-zone button {
        background-color: var(--danger-color);
        border-color: var(--danger-color);
        color: white;
    }
    .danger-zone button:hover {
        background-color: #c82333;
    }

    /* --- è¨Šæ¯æç¤º --- */
    .message {
        padding: 1rem 1.25rem;
        margin-bottom: 1rem;
        border: 1px solid transparent;
        border-radius: 6px;
    }
    .message.success { background-color: #d4edda; color: #155724; border-color: #c3e6cb;}
    .message.error { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
    .message.info { background-color: #cce5ff; color: #004085; border-color: #b8daff; }

    /* --- ç™»å…¥è¡¨å–® --- */
    #login-section input {
        width: 100%;
        max-width: 300px;
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        margin-right: 10px;
    }
    #login-section button {
        background-color: var(--primary-color);
        color: white;
    }

    /* --- éš±è—é¡˜æœ›çš„æ¨£å¼ --- */
    .wish-content.hidden {
        color: transparent;
        text-shadow: 0 0 10px rgba(0,0,0,0.3);
        user-select: none;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .wish-content.hidden:hover {
        text-shadow: 0 0 5px rgba(0,0,0,0.4);
    }
    th[onclick] { cursor: pointer; }

</style>
</head>
<body>
    <h1>å¾Œå°ç®¡ç†</h1>
    <div id="login-section">
        <label for="secret">è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼:</label>
        <input type="password" id="secret">
        <button onclick="login()">ç™»å…¥</button>
    </div>

    <div id="admin-panel" style="display:none;">
        <div id="message-area"></div>
        <h2>ç›®å‰åƒèˆ‡è€…åˆ—è¡¨</h2>
        <p id="status-text"></p>
        <div id="participants-table"></div>
        <div class="controls">
            <button onclick="toggleWishes(this)">é¡¯ç¤ºé¡˜æœ›</button>
            <button id="draw-button" onclick="startDraw()">åŸ·è¡ŒæŠ½ç±¤</button>
            <button id="send-button" onclick="sendEmails()">å¯„é€é€šçŸ¥ä¿¡</button>
            <button onclick="loadStatus()">é‡æ–°æ•´ç†</button>
        </div>
        <div class="danger-zone">
            <h3>å±éšªæ“ä½œå€</h3>
            <button onclick="resetSystem()">é‡ç½®æ•´å€‹ç³»çµ±</button>
        </div>
    </div>

    <script>
        const loginSection = document.getElementById('login-section');
        const adminPanel = document.getElementById('admin-panel');
        const messageArea = document.getElementById('message-area');
        const statusText = document.getElementById('status-text');
        const participantsTable = document.getElementById('participants-table');
        const drawButton = document.getElementById('draw-button');
        const sendButton = document.getElementById('send-button');
        let adminSecret = '';

        function showMessage(text, type = 'error') {
            messageArea.innerHTML = `<div class="message ${type}">${text}</div>`;
        }

        function login() {
            adminSecret = document.getElementById('secret').value;
            if (!adminSecret) { alert('è«‹è¼¸å…¥å¯†ç¢¼'); return; }
            loadStatus();
        }

        async function apiFetch(url, options = {}) {
            const headers = { 'Content-Type': 'application/json', ...options.headers, 'Authorization': `Bearer ${adminSecret}` };
            const response = await fetch(url, { ...options, headers });
            if (response.status === 401) { throw new Error('å¯†ç¢¼éŒ¯èª¤æˆ–æ†‘è­‰å·²éæœŸã€‚'); }
            return response;
        }

        async function loadStatus() {
            const groupMap = { 1: 'å…‰ä½‘', 2: 'Jefferson', 3: 'PJä¸€å®¶', 4: 'ç‘å›ä¸€å®¶', 5: 'è±ªå“¥ä¸€å®¶' };
            try {
                const response = await apiFetch('/api/status');
                if (!response.ok) throw new Error('ç„¡æ³•è¼‰å…¥è³‡æ–™');
                
                const data = await response.json();
                loginSection.style.display = 'none';
                adminPanel.style.display = 'block';
                messageArea.innerHTML = '';

                statusText.textContent = `äººæ•¸: ${data.count} / 8`;
                
                let html = '<table><tr><th>ID</th><th>åå­—</th><th>çµ„åˆ¥</th><th onclick="toggleWishes(document.querySelector(\'.controls button\'))" style="cursor:pointer;">è¨±é¡˜å…§å®¹ ğŸ‘ï¸</th><th>æŠ½åˆ°èª°(ID)</th><th>æ“ä½œ</th></tr>';
                const participants = data.participants || [];

                participants.forEach(p => {
                    html += `<tr>
                        <td>${p.id}</td>
                        <td>${p.name}</td>
                        <td>${groupMap[p.group_id] || 'æœªçŸ¥'}</td>
                        <td class="wish-content hidden">${p.wish}</td>
                        <td>${p.assigned_to || 'N/A'}</td>
                        <td><button class="delete-btn" onclick="deleteParticipant(${p.id}, '${p.name}')" ${data.draw_completed ? 'disabled' : ''}>åˆªé™¤</button></td>
                    </tr>`;
                });
                html += '</table>';
                participantsTable.innerHTML = html;

                // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                const canDraw = data.count === 8 && !data.draw_completed;
                const canSend = data.draw_completed && !data.emails_sent;
                drawButton.disabled = !canDraw;
                sendButton.disabled = !canSend;
                
                if (data.draw_completed) drawButton.textContent = 'å·²æŠ½ç±¤';
                else drawButton.textContent = 'åŸ·è¡ŒæŠ½ç±¤';
                if (data.emails_sent) sendButton.textContent = 'å·²å¯„ä¿¡';
                else sendButton.textContent = 'å¯„é€é€šçŸ¥ä¿¡';

            } catch (error) { alert(error.message); adminSecret = ''; }
        }

        // éœ€æ±‚ 2: é¡¯ç¤º/éš±è—é¡˜æœ›
        function toggleWishes(button) {
            const wishes = document.querySelectorAll('.wish-content');
            const isHidden = wishes[0]?.classList.contains('hidden');
            wishes.forEach(w => w.classList.toggle('hidden'));
            button.textContent = isHidden ? 'éš±è—é¡˜æœ›' : 'é¡¯ç¤ºé¡˜æœ›';
        }

        async function startDraw() {
            if (!confirm('ç¢ºå®šè¦åŸ·è¡ŒæŠ½ç±¤å—ï¼Ÿæ­¤å‹•ä½œå°‡å„²å­˜é…å°çµæœã€‚')) return;
            drawButton.disabled = true;
            try {
                const response = await apiFetch('/api/draw', { method: 'POST' });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);
                showMessage(result.message, 'success');
                loadStatus();
            } catch (error) { showMessage(error.message, 'error'); loadStatus(); }
        }
        
        // éœ€æ±‚ 4: å¸¶æœ‰é‡‘é¡æç¤ºçš„å¯„ä¿¡åŠŸèƒ½
        async function sendEmails() {
            const giftAmount = prompt("è«‹è¼¸å…¥ç¦®ç‰©é‡‘é¡ç¯„åœ (ä¾‹å¦‚ï¼š$500-$700å…ƒ)", "$500 - $700 å…ƒ");
            if (!giftAmount) return; // å¦‚æœä½¿ç”¨è€…å–æ¶ˆè¼¸å…¥

            sendButton.disabled = true;
            showMessage('æ­£åœ¨æº–å‚™å¯„é€æ‰€æœ‰ä¿¡ä»¶ï¼Œè«‹ç¨å€™...', 'info');
            try {
                const response = await apiFetch('/api/send-emails', {
                    method: 'POST',
                    body: JSON.stringify({ giftAmount: giftAmount })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);
                showMessage(result.message, 'success');
                loadStatus();
            } catch (error) { showMessage(error.message, 'error'); loadStatus(); }
        }

        // å…¶ä»–å‡½å¼ (deleteParticipant, resetSystem) ä¿æŒä¸è®Š
        async function deleteParticipant(userId, userName) {
            if (!confirm(`æ‚¨ç¢ºå®šè¦åˆªé™¤ã€Œ${userName}ã€çš„è³‡æ–™å—ï¼Ÿ`)) return;
            try {
                const response = await apiFetch('/api/delete-user', { method: 'POST', body: JSON.stringify({ userId }) });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);
                showMessage(result.message, 'success'); loadStatus();
            } catch (error) { showMessage(error.message, 'error'); }
        }
        async function resetSystem() {
            if (!confirm('ï¼ï¼ï¼è­¦å‘Šï¼ï¼ï¼\næ‚¨ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) return;
            try {
                const response = await apiFetch('/api/reset', { method: 'POST' });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);
                showMessage(result.message, 'success'); loadStatus();
            } catch (error) { showMessage(error.message, 'error'); }
        }
    </script>
</body>
</html>
